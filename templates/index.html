<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>📘 אתר לימוד מילים באנגלית</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; direction: rtl; background: #f9f9f9; margin: 0; padding: 20px; }
    h1 { text-align: center; }
    button { padding: 8px 14px; border: none; border-radius: 8px; cursor: pointer; background: #1976d2; color: white; }
    button:hover { background: #125a9e; }
    .card { background: white; margin: 10px auto; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 500px; }
    .date { color: #555; font-size: 14px; }
    .stats { margin: 8px 0; }
    .ok { color: green; }
    .bad { color: red; }
  </style>
</head>

<body>
  <h1>📘 אתר לימוד מילים באנגלית</h1>

  <div class="card">
    <h3>➕ יצירת רשימה חדשה</h3>
    <input id="newListName" placeholder="שם הרשימה">
    <button onclick="createList()">צור רשימה</button>
  </div>

  <div class="card">
    <h3>📥 ייבוא מקובץ Excel</h3>
    <input type="file" id="fileInput">
    <button onclick="importExcel()">ייבא קובץ</button>
  </div>

  <div class="card">
    <h3>📤 הורד את כל המילים לקובץ Excel</h3>
    <button onclick="downloadAll()">הורד את כל הנתונים</button>
  </div>

  <h3 style="text-align:center;">📋 הרשימות שלך (מסודרות לפי תאריך חידון)</h3>
  <div id="listsContainer"></div>

  <script>
    async function loadLists() {
      const res = await fetch("/api/lists");
      const lists = await res.json();
      const container = document.getElementById("listsContainer");
      container.innerHTML = "";

      for (const list of lists) {
        const lastQuiz = list.last_quiz_date ? new Date(list.last_quiz_date).toLocaleDateString('he-IL') : "—";
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h3>רשימה ${list.id}</h3>
          <div class="stats">
            מילים: <span class="ok">✅ ${list.correct}</span> /
            <span class="bad">❌ ${list.wrong}</span>
          </div>
          <div class="date">📅 נבחנת לאחרונה: ${lastQuiz}</div>
          <button onclick="startQuiz('${list.name}')">🎯 התחל חידון</button>
          <button onclick="manageList('${list.name}')">נהל</button>
        `;
        container.appendChild(card);
      }
    }

    async function startQuiz(listName) {
      alert("🎯 החידון התחיל לרשימה: " + listName);

      // === עדכון תאריך חידון אחרון בשרת ===
      try {
        await fetch("/api/update_quiz_date", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ list_name: listName })
        });
        console.log("✅ עודכן תאריך חידון אחרון ל־", listName);
      } catch (e) {
        console.error("❌ שגיאה בעדכון תאריך:", e);
      }

      await loadLists(); // ריענון כדי להציג את התאריך החדש
    }

    async function createList() {
      const name = document.getElementById("newListName").value.trim();
      if (!name) return alert("אנא הכנס שם רשימה");
      await fetch("/api/create_list", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name })
      });
      await loadLists();
    }

    async function importExcel() {
      const fileInput = document.getElementById("fileInput");
      if (!fileInput.files.length) return alert("בחר קובץ קודם");
      const formData = new FormData();
      formData.append("file", fileInput.files[0]);
      const res = await fetch("/api/import_excel", { method: "POST", body: formData });
      const data = await res.json();
      alert(data.message || "הסתיים!");
      await loadLists();
    }

    async function downloadAll() {
      window.location.href = "/api/export_excel";
    }

    async function manageList(name) {
      alert("ניהול הרשימה: " + name);
    }

    loadLists();
  </script>
</body>
</html>