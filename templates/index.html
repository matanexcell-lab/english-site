<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<title>××ª×¨ ×œ×™××•×“ ××™×œ×™× ×‘×× ×’×œ×™×ª ğŸ“˜</title>
<link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="container">
  <h1>××ª×¨ ×œ×™××•×“ ××™×œ×™× ×‘×× ×’×œ×™×ª ğŸ“˜</h1>

  <h3>â• ×™×¦×™×¨×ª ×¨×©×™××” ×—×“×©×”</h3>
  <input id="newListName" placeholder="×©× ×”×¨×©×™××”">
  <button onclick="createList()">×¦×•×¨ ×¨×©×™××”</button>

  <h3>ğŸ“¥ ×™×™×‘×•× ××§×•×‘×¥ Excel</h3>
  <input type="file" id="excelFile" accept=".xlsx,.xls" />
  <button onclick="importExcel()">×™×™×‘× ×§×•×‘×¥</button>

  <h3>ğŸ“¤ ×™×™×¦×•× ×¨×©×™××•×ª ×œ××§×¡×œ</h3>
  <button onclick="exportExcel()">×”×•×¨×“ ×§×•×‘×¥ Excel</button>

  <h2>×”×¨×©×™××•×ª ×©×œ×š ğŸ—’ï¸</h2>
  <div id="lists"></div>

  <hr>
  <div id="listManager" style="display:none;">
    <h2 id="manageTitle"></h2>
    <input id="newEn" placeholder="English">
    <input id="newHe" placeholder="×¢×‘×¨×™×ª">
    <button onclick="addWord()">×”×•×¡×£ ××™×œ×”</button>
    <div id="wordsList"></div>
    <button onclick="backToLists()">×—×–×¨×” ×œ×¨×©×™××•×ª</button>
  </div>
</div>

<script>
let data = {};
let currentList = null;

async function loadLists(){
  const r = await fetch("/api/lists");
  data = await r.json();
  const div = document.getElementById("lists");
  div.innerHTML = "";
  for (const name in data){
    const words = data[name];
    const ok = words.reduce((a,w)=>a+(w.ok||0),0);
    const bad = words.reduce((a,w)=>a+(w.bad||0),0);
    const btns = `
      <button onclick="openList('${name}')">× ×”×œ</button>
      <button onclick="quiz('${name}','EN')">ENâ†’HE ×ª×¨×’×•×œ</button>
      <button onclick="quiz('${name}','HE')">HEâ†’EN ×ª×¨×’×•×œ</button>
    `;
    div.innerHTML += `<div><b>${name}</b> | ××™×œ×™×:${words.length} | âœ…${ok} âŒ${bad}<br>${btns}</div><hr>`;
  }
}

function createList(){
  const name = document.getElementById("newListName").value.trim();
  if(!name) return alert("× × ×œ×”×–×™×Ÿ ×©× ×¨×©×™××”");
  if(data[name]) return alert("×”×¨×©×™××” ×›×‘×¨ ×§×™×™××ª");
  data[name] = [];
  saveLists();
}

function openList(name){
  currentList = name;
  document.getElementById("lists").style.display="none";
  document.getElementById("listManager").style.display="block";
  document.getElementById("manageTitle").innerText = `× ×™×”×•×œ ×¨×©×™××”: ${name} (×¢×“ 15 ××™×œ×™×)`;
  renderWords();
}

function backToLists(){
  currentList=null;
  document.getElementById("lists").style.display="block";
  document.getElementById("listManager").style.display="none";
  loadLists();
}

function renderWords(){
  const div = document.getElementById("wordsList");
  const words = data[currentList]||[];
  div.innerHTML="";
  words.forEach((w,i)=>{
    const ratio = (w.ok+w.bad>0)?(w.bad/(w.ok+w.bad)).toFixed(2):"0.00";
    div.innerHTML+=`
      <div>
        <button style="background:red" onclick="delWord(${i})">××—×§</button>
        <span>×™×—×¡ğŸ”¥: ${ratio}</span>
        âŒ${w.bad} âœ…${w.ok} â€” ${w.en} â€” ${w.he}
      </div>`;
  });
}

function addWord(){
  const en=document.getElementById("newEn").value.trim();
  const he=document.getElementById("newHe").value.trim();
  if(!en||!he) return alert("× × ×œ×”×–×™×Ÿ ××™×œ×” ×‘×× ×’×œ×™×ª ×•×‘×¢×‘×¨×™×ª");
  const words=data[currentList];
  if(words.length>=15) return alert("××™ ××¤×©×¨ ×™×•×ª×¨ ×-15 ××™×œ×™× ×‘×¨×©×™××”");
  words.push({en,he,ok:0,bad:0});
  document.getElementById("newEn").value="";
  document.getElementById("newHe").value="";
  saveLists();
}

function delWord(i){
  data[currentList].splice(i,1);
  saveLists();
}

async function saveLists(){
  await fetch("/api/lists",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:currentList,words:data[currentList]})});
  renderWords();
  loadLists();
}

function quiz(name,dir){
  const list=data[name];
  if(!list||!list.length) return alert("××™×Ÿ ××™×œ×™× ×‘×¨×©×™××”");
  // ×“×™×¨×•×’ ×œ×¤×™ ×™×—×¡ bad/ok
  const sorted=[...list].sort((a,b)=>{
    const ra=(a.ok+a.bad)>0?(a.bad/(a.ok+a.bad)):0;
    const rb=(b.ok+b.bad)>0?(b.bad/(b.ok+b.bad)):0;
    return rb-ra;
  });
  let i=0;
  ask();

  function ask(){
    if(i>=sorted.length){saveLists();return alert("×¡×™×•× ×ª×¨×’×•×œ âœ…");}
    const w=sorted[i];
    const q=(dir==="EN")?w.en:w.he;
    const ans=prompt(`(${i+1}/${sorted.length}) ${q}`);
    if(ans===null)return;
    const correct=(dir==="EN")?w.he:w.en;
    if(ans.trim()===correct.trim()){
      alert("× ×›×•×Ÿ!");
      w.ok=(w.ok||0)+1;
    } else {
      alert(`×œ× × ×›×•×Ÿ âŒ ×”×ª×©×•×‘×”: ${correct}`);
      w.bad=(w.bad||0)+1;
    }
    i++;
    saveLists();
    ask();
  }
}

async function importExcel(){
  const fileInput=document.getElementById("excelFile");
  if(!fileInput.files.length)return alert("× × ×œ×‘×—×•×¨ ×§×•×‘×¥ Excel");
  const formData=new FormData();
  formData.append("file",fileInput.files[0]);
  const r=await fetch("/api/import_excel",{method:"POST",body:formData});
  const js=await r.json();
  if(!js.ok)return alert(js.error||"×©×’×™××” ×‘×™×™×‘×•×");
  alert(js.message||"×™×™×‘×•× ×”×¡×ª×™×™× ×‘×”×¦×œ×—×”!");
  loadLists();
}

function exportExcel(){
  window.location.href="/api/export_excel";
}

loadLists();
</script>
</body>
</html>
