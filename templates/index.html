<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>📘 אתר לימוד מילים באנגלית</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 20px;
      direction: rtl;
      text-align: center;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 5px #aaa;
    }
    h1 { font-size: 26px; margin-bottom: 10px; }
    button {
      padding: 6px 10px;
      margin: 3px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    input[type="text"], input[type="file"] {
      padding: 6px;
      margin: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 45%;
    }
    ul { list-style-type: none; padding: 0; }
    li { margin: 6px 0; }
    .word-item {
      display: flex;
      flex-direction: column;
      background: #fafafa;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 6px;
      box-shadow: 0 0 3px #ddd;
    }
    .word-text {
      font-size: 16px;
      margin-bottom: 6px;
    }
    .stat { margin: 0 4px; font-size: 14px; }
    .success { color: green; }
    .fail { color: red; }
    .ratio { background: #eee; border-radius: 10px; padding: 2px 8px; font-size: 14px; }
    .buttons-row {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 4px;
    }
    .import-export {
      margin: 20px 0;
      border-top: 1px solid #ddd;
      padding-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>📘 אתר לימוד מילים באנגלית</h1>

    <h3>➕ יצירת רשימה חדשה</h3>
    <input type="text" id="newListName" placeholder="שם הרשימה" />
    <button onclick="createList()">צור רשימה</button>

    <div class="import-export">
      <h3>📥 ייבוא מקובץ Excel</h3>
      <input type="file" id="excelFile" accept=".xlsx" />
      <button onclick="importExcel()">ייבא קובץ</button>

      <h3>📤 הורד את כל המילים לקובץ Excel</h3>
      <button onclick="window.location.href='/api/download_excel'">הורד את כל הנתונים</button>
    </div>

    <h3>📋 הרשימות שלך</h3>
    <div id="lists"></div>

    <div id="listView" style="display:none;">
      <h3 id="listTitle"></h3>
      <input type="text" id="newWordEN" placeholder="English" />
      <input type="text" id="newWordHE" placeholder="עברית" />
      <button onclick="addWord()">הוסף מילה</button>
      <ul id="wordsList"></ul>
      <button onclick="backToLists()">⬅️ חזרה לרשימות</button>
    </div>
  </div>

  <script>
    let allData = {};
    let currentList = null;

    async function loadLists() {
      const res = await fetch("/api/lists");
      allData = await res.json();
      showLists();
    }

    function showLists() {
      document.getElementById("lists").innerHTML = "";
      document.getElementById("listView").style.display = "none";
      for (const [name, words] of Object.entries(allData)) {
        const correct = words.reduce((a, w) => a + (w.correct || 0), 0);
        const wrong = words.reduce((a, w) => a + (w.wrong || 0), 0);
        const div = document.createElement("div");
        div.innerHTML = `
          <h3>${name}</h3>
          <p>מילים: ${words.length} ✅ ${correct} ❌ ${wrong}</p>
          <button onclick="manageList('${name}')">נהל</button>
        `;
        document.getElementById("lists").appendChild(div);
      }
    }

    function createList() {
      const name = document.getElementById("newListName").value.trim();
      if (!name) return alert("❗ הזן שם רשימה");
      if (allData[name]) return alert("❗ רשימה בשם זה כבר קיימת");
      allData[name] = [];
      saveLists();
      showLists();
      document.getElementById("newListName").value = "";
    }

    function manageList(name) {
      currentList = name;
      document.getElementById("listTitle").textContent = "ניהול רשימה: " + name;
      document.getElementById("lists").innerHTML = "";
      document.getElementById("listView").style.display = "block";
      showWords();
    }

    function showWords() {
      const ul = document.getElementById("wordsList");
      ul.innerHTML = "";
      const words = allData[currentList];
      for (const w of words) {
        const ratio = w.wrong + w.correct > 0 ? (w.wrong / (w.correct + 1)).toFixed(2) : "0.00";
        const li = document.createElement("li");
        li.className = "word-item";
        li.innerHTML = `
          <div class="word-text">
            <b>${w.en}</b> — ${w.he}
          </div>
          <div>
            🔥 יחס: ${ratio}
            <span class="stat success">✅ ${w.correct}</span>
            <span class="stat fail">❌ ${w.wrong}</span>
          </div>
          <div class="buttons-row">
            <button onclick="editWord('${w.en}')">✏️ ערוך</button>
            <button onclick="deleteWord('${w.en}')">🗑️ מחק</button>
          </div>`;
        ul.appendChild(li);
      }
    }

    function addWord() {
      const en = document.getElementById("newWordEN").value.trim();
      const he = document.getElementById("newWordHE").value.trim();
      if (!en || !he) return alert("❗ מלא את שני השדות");
      allData[currentList].push({ en, he, correct: 0, wrong: 0 });
      saveLists();
      showWords();
      document.getElementById("newWordEN").value = "";
      document.getElementById("newWordHE").value = "";
    }

    function deleteWord(en) {
      allData[currentList] = allData[currentList].filter(w => w.en !== en);
      saveLists();
      showWords();
    }

    function editWord(en) {
      const word = allData[currentList].find(w => w.en === en);
      if (!word) return;
      const newEN = prompt("מילה באנגלית:", word.en) || word.en;
      const newHE = prompt("תרגום בעברית:", word.he) || word.he;
      word.en = newEN;
      word.he = newHE;
      saveLists();
      showWords();
    }

    function backToLists() {
      document.getElementById("listView").style.display = "none";
      showLists();
    }

    async function saveLists() {
      for (const [name, words] of Object.entries(allData)) {
        await fetch("/api/lists", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, words })
        });
      }
    }

    async function importExcel() {
      const fileInput = document.getElementById("excelFile");
      if (!fileInput.files.length) return alert("בחר קובץ Excel");
      const formData = new FormData();
      formData.append("file", fileInput.files[0]);
      const res = await fetch("/api/import_excel", { method: "POST", body: formData });
      const data = await res.json();
      alert(data.message);
      loadLists();
    }

    loadLists();
  </script>
</body>
</html>