<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>לימוד מילים באנגלית</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="container">
    <h1>אתר לימוד מילים באנגלית 📘</h1>

    <!-- יצירת רשימה חדשה -->
    <section>
      <h2>➕ יצירת רשימה חדשה</h2>
      <input id="newListName" placeholder="שם הרשימה" />
      <button id="createBtn">צור רשימה</button>
    </section>

    <!-- כל הרשימות -->
    <section>
      <h2>📄 הרשימות שלך</h2>
      <div id="lists"></div>
    </section>

    <hr/>

    <!-- ניהול רשימה -->
    <section id="manage" style="display:none;">
      <h2>ניהול רשימה: <span id="mListName"></span> (עד 15 מילים)</h2>

      <div class="row">
        <input id="en" placeholder="English" />
        <input id="he" placeholder="עברית" />
        <button onclick="addWord()">הוסף מילה</button>
      </div>

      <ul id="words"></ul>
      <button class="secondary" onclick="backToLists()">חזרה לרשימות</button>
    </section>

    <hr/>

    <!-- חידון -->
    <section id="quiz" style="display:none;">
      <h2>חידון: <span id="qListName"></span></h2>
      <div id="qNumber"></div>
      <div id="qPrompt"></div>
      <input id="qAnswer" placeholder="התשובה שלך" onkeydown="if(event.key==='Enter') checkAnswer()" />
      <button onclick="checkAnswer()">בדוק</button>
      <div id="qFeedback"></div>
      <button class="secondary" onclick="showManage()">סיום חידון</button>
    </section>
  </div>

<script>
  // ===== טעינה ראשונית =====
  document.addEventListener("DOMContentLoaded", () => {
    loadLists();
    document.getElementById("createBtn").addEventListener("click", createList);
  });

  // ===== רשימות =====
  async function loadLists() {
    try {
      const r = await fetch("/api/lists");
      if (!r.ok) throw new Error("בעיה בתקשורת עם השרת");
      const js = await r.json();
      const cont = document.getElementById("lists");
      cont.innerHTML = "";
      js.lists.forEach(li => {
        const row = document.createElement("div");
        row.className = "list-row";
        row.innerHTML = `
          <div class="list-name">${li.name}</div>
          <div class="list-stats">מילים: ${li.count} | ✅ ${li.ok} | ❌ ${li.bad}</div>
          <div class="list-actions">
            <button onclick="manage('${li.name}')">נהל</button>
            <button onclick="startQuickQuiz('${li.name}', 'en2he')">תרגול EN→HE</button>
            <button onclick="startQuickQuiz('${li.name}', 'he2en')">תרגול HE→EN</button>
          </div>
        `;
        cont.appendChild(row);
      });
    } catch (err) {
      alert("שגיאה בטעינת רשימות:\n" + err.message);
    }
  }

  async function createList() {
    const name = document.getElementById("newListName").value.trim();
    if (!name) return alert("נא להזין שם לרשימה");

    try {
      const r = await fetch("/api/lists", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name })
      });

      const js = await r.json();
      if (!js.ok) {
        alert(js.error || "שגיאה בהוספת הרשימה");
        return;
      }

      document.getElementById("newListName").value = "";
      alert("הרשימה נוספה בהצלחה!");
      loadLists();
    } catch (err) {
      alert("שגיאה בעת יצירת רשימה:\n" + err.message);
    }
  }

  // ===== ניהול מילים =====
  let currentList = null;
  let currentWords = [];

  async function manage(name) {
    currentList = name;
    document.getElementById("mListName").innerText = name;
    document.getElementById("manage").style.display = "";
    document.getElementById("quiz").style.display = "none";
    await refreshWords();
  }

  async function refreshWords() {
    const r = await fetch(`/api/list/${encodeURIComponent(currentList)}`);
    const js = await r.json();
    currentWords = js.words || [];

    const ul = document.getElementById("words");
    ul.innerHTML = "";
    currentWords.forEach(w => {
      const ratio = w.ratio !== undefined ? w.ratio.toFixed(2) : (w.bad / (w.ok + 1)).toFixed(2);
      const li = document.createElement("li");
      li.innerHTML = `
        <span>${w.en} — ${w.he}</span>
        <span class="chip">✅ ${w.ok || 0}</span>
        <span class="chip">❌ ${w.bad || 0}</span>
        <span class="chip">🔥 יחס: ${ratio}</span>
        <button class="danger" onclick="deleteWord('${w.en}', '${w.he}')">מחק</button>
      `;
      ul.appendChild(li);
    });
  }

  async function addWord() {
    const en = document.getElementById("en").value.trim();
    const he = document.getElementById("he").value.trim();
    if (!en || !he) return alert("נא למלא את שתי השדות");

    const r = await fetch("/api/words", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ list: currentList, en, he })
    });
    const js = await r.json();
    if (!js.ok) return alert(js.error || "שגיאה");
    document.getElementById("en").value = "";
    document.getElementById("he").value = "";
    refreshWords();
    loadLists();
  }

  async function deleteWord(en, he) {
    if (!confirm(`למחוק את המילה "${en}"?`)) return;
    const url = `/api/words?list=${encodeURIComponent(currentList)}&en=${encodeURIComponent(en)}&he=${encodeURIComponent(he)}`;
    const r = await fetch(url, { method: "DELETE" });
    const js = await r.json();
    if (!js.ok) return alert(js.error || "שגיאה במחיקה");
    refreshWords();
    loadLists();
  }

  // ===== חזרה =====
  function backToLists() {
    document.getElementById("manage").style.display = "none";
    document.getElementById("quiz").style.display = "none";
    loadLists();
  }

  // ===== חידון =====
  async function startQuickQuiz(listName, mode) {
    currentList = listName;
    quizMode = mode;
    const r = await fetch(`/api/list/${encodeURIComponent(listName)}`);
    const js = await r.json();
    if (!js.ok) return alert("שגיאה בטעינת הרשימה");
    currentWords = js.words || [];
    if (currentWords.length === 0) return alert("אין מילים ברשימה הזו!");

    // מיין לפי יחס יורד (קשות קודם)
    quizOrder = [...currentWords.keys()].sort((a, b) => {
      const ratioA = currentWords[a].ratio ?? (currentWords[a].bad / (currentWords[a].ok + 1));
      const ratioB = currentWords[b].ratio ?? (currentWords[b].bad / (currentWords[b].ok + 1));
      return ratioB - ratioA;
    });

    quizIndex = 0;
    document.getElementById("qListName").innerText = `${listName} (${mode === 'en2he' ? 'EN→HE' : 'HE→EN'})`;
    document.getElementById("quiz").style.display = "";
    document.getElementById("manage").style.display = "none";
    showQuestion();
  }

  let quizMode = "en2he";
  let quizOrder = [];
  let quizIndex = 0;

  function showQuestion() {
    if (quizIndex >= quizOrder.length) {
      document.getElementById("qPrompt").innerText = "סיימת את החידון! 🎉";
      document.getElementById("qNumber").innerText = "";
      document.getElementById("qFeedback").innerText = "";
      return;
    }
    const w = currentWords[quizOrder[quizIndex]];
    document.getElementById("qNumber").innerText = `שאלה ${quizIndex + 1} מתוך ${quizOrder.length}`;
    document.getElementById("qAnswer").value = "";
    document.getElementById("qAnswer").focus();

    if (quizMode === "en2he") {
      document.getElementById("qPrompt").innerText = `תרגם לעברית: ${w.en}`;
    } else {
      document.getElementById("qPrompt").innerText = `Translate to English: ${w.he}`;
    }
    document.getElementById("qFeedback").innerText = "";
  }

  async function checkAnswer() {
    if (quizIndex >= quizOrder.length) return;
    const w = currentWords[quizOrder[quizIndex]];
    const ans = document.getElementById("qAnswer").value.trim();
    const correct = quizMode === "en2he" ? w.he : w.en;
    const isCorrect = ans.toLowerCase() === correct.toLowerCase();

    document.getElementById("qFeedback").innerText = isCorrect ? "✅ נכון!" : `❌ לא נכון. התשובה: ${correct}`;

    await fetch("/api/answer", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ list: currentList, en: w.en, he: w.he, correct: isCorrect })
    });

    quizIndex++;
    setTimeout(() => showQuestion(), 700);
  }

  function showManage() {
    document.getElementById("quiz").style.display = "none";
    document.getElementById("manage").style.display = "";
    refreshWords();
  }
</script>
</body>
</html>
