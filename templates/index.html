<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>ğŸ“˜ ××ª×¨ ×œ×™××•×“ ××™×œ×™× ×‘×× ×’×œ×™×ª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 20px;
      direction: rtl;
      text-align: center;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 5px #aaa;
    }
    button {
      padding: 8px 14px;
      margin: 4px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { background: #005dc1; }
    input[type="text"], input[type="file"] {
      padding: 6px;
      margin: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 45%;
    }
    ul { list-style-type: none; padding: 0; }
    li { margin: 6px 0; }
    .word-item {
      background: #fafafa;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 6px;
      box-shadow: 0 0 3px #ddd;
    }
    .success { color: green; }
    .fail { color: red; }

    #quizArea { display: none; }
    #answerInput {
      padding: 10px;
      font-size: 18px;
      width: 70%;
      border-radius: 5px;
      border: 1px solid #999;
      margin-top: 10px;
    }

    #directionPopup {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #popupBox {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px #333;
      text-align: center;
      width: 300px;
    }

    #continueBtn {
      display: none;
      background: #28a745;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div class="container">

    <h1>ğŸ“˜ ××ª×¨ ×œ×™××•×“ ××™×œ×™× ×‘×× ×’×œ×™×ª</h1>

    <h3>â• ×™×¦×™×¨×ª ×¨×©×™××” ×—×“×©×”</h3>
    <input type="text" id="newListName" placeholder="×©× ×”×¨×©×™××”" />
    <button onclick="createList()">×¦×•×¨ ×¨×©×™××”</button>

    <h3>ğŸ“¥ ×™×™×‘×•× ××§×•×‘×¥ Excel</h3>
    <input type="file" id="excelFile" accept=".xlsx" />
    <button onclick="importExcel()">×™×™×‘× ×§×•×‘×¥</button>

    <h3>ğŸ“¤ ×”×•×¨×“ ××ª ×›×œ ×”××™×œ×™× ×œ×§×•×‘×¥ Excel</h3>
    <button onclick="window.location.href='/api/download_excel'">×”×•×¨×“ ××ª ×›×œ ×”× ×ª×•× ×™×</button>

    <h3>ğŸ“‹ ×”×¨×©×™××•×ª ×©×œ×š (××¡×•×“×¨×•×ª ×œ×¤×™ ×ª××¨×™×š ×—×™×“×•×Ÿ)</h3>
    <div id="lists"></div>

    <div id="listView" style="display:none;">
      <h3 id="listTitle"></h3>
      <input type="text" id="newWordEN" placeholder="English" />
      <input type="text" id="newWordHE" placeholder="×¢×‘×¨×™×ª" />
      <button onclick="addWord()">â• ×”×•×¡×£ ××™×œ×”</button>
      <ul id="wordsList"></ul>
      <button onclick="backToLists()">â¬…ï¸ ×—×–×¨×” ×œ×¨×©×™××•×ª</button>
    </div>

    <!-- ×—×™×“×•×Ÿ -->
    <div id="quizArea">
      <h3 id="quizTitle"></h3>
      <div id="quizQuestion"></div>

      <input type="text" id="answerInput"
        placeholder="×”×§×œ×“ ××ª ×”×ª×¨×’×•×..."
        onkeypress="if(event.key==='Enter') checkAnswer()" />

      <div id="feedback"></div>

      <button onclick="checkAnswer()">×‘×“×•×§ ×ª×©×•×‘×”</button>
      <button onclick="endQuiz()">âœ–ï¸ ×¡×™×™× ×—×™×“×•×Ÿ</button>

      <!-- ×›×¤×ª×•×¨ ×”××©×š -->
      <button id="continueBtn" onclick="continueQuizAnyway()">â–¶ï¸ ×”××©×š ×‘×›×œ ×–××ª</button>
    </div>
  </div>

  <div id="directionPopup">
    <div id="popupBox">
      <h3>×‘×—×¨ ×¡×•×’ ×—×™×“×•×Ÿ:</h3>
      <button onclick="setQuizDirection('EN_HE')">×× ×’×œ×™×ª â†’ ×¢×‘×¨×™×ª</button>
      <button onclick="setQuizDirection('HE_EN')">×¢×‘×¨×™×ª â†’ ×× ×’×œ×™×ª</button>
      <br><br>
      <button style="background:#999" onclick="closePopup()">×‘×™×˜×•×œ</button>
    </div>
  </div>

<script>

let allData = {};
let lastQuizDates = {};
let currentList = null;
let quizWords = [];
let currentIndex = 0;
let currentQuestion = null;
let quizDirection = "EN_HE";

/* ---------------------- ×˜×¢×™× ×ª ×¨×©×™××•×ª ---------------------- */

async function loadLists() {
  const res = await fetch("/api/lists");
  allData = await res.json();

  const res2 = await fetch("/api/last_quiz_dates");
  lastQuizDates = await res2.json();

  showLists();
}

/* ... ×©××¨ ×”×¤×•× ×§×¦×™×•×ª ×–×”×•×ª ... */

/* ---------------------- ×—×™×“×•×Ÿ ---------------------- */

function showQuizQuestion() {

  if (currentIndex >= quizWords.length) {
    endQuiz();
    return;
  }

  currentQuestion = quizWords[currentIndex];

  const remaining = quizWords.slice(currentIndex);
  const knownOnly = remaining.every(w => {
    const ratio = (w.wrong + 1) / (w.correct + 1);
    return ratio < 1;
  });

  if (knownOnly && remaining.length > 0) {

    document.getElementById("quizQuestion").innerHTML =
      "ğŸ‰ ×›×œ ×”××™×œ×™× ×©× ×•×ª×¨×• ×”×Ÿ ××™×œ×™× ×©××ª×” ×›×‘×¨ ×™×•×“×¢!<br>×‘××¤×©×¨×•×ª×š ×œ×¡×™×™× ××• ×œ×”××©×™×š ××ª ×”×—×™×“×•×Ÿ.";

    document.getElementById("answerInput").style.display = "none";
    document.getElementById("continueBtn").style.display = "inline-block";

    document.getElementById("feedback").textContent = "";
    return;
  }

  document.getElementById("continueBtn").style.display = "none";
  document.getElementById("answerInput").style.display = "inline-block";

  document.getElementById("quizTitle").textContent =
    `×©××œ×” ${currentIndex + 1} ××ª×•×š ${quizWords.length}`;

  document.getElementById("quizQuestion").textContent =
    quizDirection === "EN_HE" ? currentQuestion.en : currentQuestion.he;

  document.getElementById("answerInput").value = "";
  document.getElementById("feedback").textContent = "";
  document.getElementById("answerInput").focus();
}


function continueQuizAnyway() {

  /** â­ ×ª×™×§×•×Ÿ ×§×¨×™×˜×™ â­ */
  currentIndex++;   // ×œ×¢×‘×•×¨ ×œ×©××œ×” ×”×‘××” ×—×•×‘×”

  document.getElementById("continueBtn").style.display = "none";
  document.getElementById("answerInput").style.display = "inline-block";

  showQuizQuestion();
}

function checkAnswer() {
  const userAnswer = document.getElementById("answerInput").value.trim();
  if (!userAnswer) return;

  const correctAns = quizDirection === "EN_HE"
    ? currentQuestion.he
    : currentQuestion.en;

  if (normalize(userAnswer) === normalize(correctAns)) {
    currentQuestion.correct = (currentQuestion.correct||0) + 1;
    document.getElementById("feedback").innerHTML = "âœ… ×ª×©×•×‘×” × ×›×•× ×”!";
  }
  else {
    currentQuestion.wrong = (currentQuestion.wrong||0) + 1;
    document.getElementById("feedback").innerHTML =
      `âŒ ×œ× × ×›×•×Ÿ! ×”×ª×©×•×‘×” ×”×™×: ${correctAns}`;
  }

  saveLists();
  currentIndex++;

  setTimeout(showQuizQuestion, 700);
}

function endQuiz() {
  alert("×”×—×™×“×•×Ÿ ×”×¡×ª×™×™×! ğŸ‰");
  document.getElementById("quizArea").style.display = "none";
  document.getElementById("lists").style.display = "block";
  loadLists();
}

function normalize(s){
  return s.trim().toLowerCase();
}

loadLists();

</script>
</body>
</html>