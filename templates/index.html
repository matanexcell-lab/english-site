<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“˜ ××ª×¨ ×œ×™××•×“ ××™×œ×™× ×‘×× ×’×œ×™×ª</title>
  <link rel="stylesheet" href="/static/style.css">
  <script>
    let currentList = null;

    // --- ×˜×¢×Ÿ ×¨×©×™××•×ª ---
    async function loadLists() {
      const res = await fetch("/api/lists");
      const data = await res.json();

      const container = document.getElementById("lists");
      container.innerHTML = "";

      for (const [name, words] of Object.entries(data)) {
        const correct = words.reduce((a, w) => a + (w.correct || 0), 0);
        const wrong = words.reduce((a, w) => a + (w.wrong || 0), 0);

        const div = document.createElement("div");
        div.className = "list-card";
        div.innerHTML = `
          <div>
            <b>${name}</b> | ğŸŸ© ${correct} | âŒ ${wrong} | ××™×œ×™×: ${words.length}
          </div>
          <button onclick="manageList('${name}')">× ×”×œ</button>
          <button onclick="startQuiz('${name}', 'en2he')">EN â†’ HE ×ª×¨×’×•×œ</button>
          <button onclick="startQuiz('${name}', 'he2en')">HE â†’ EN ×ª×¨×’×•×œ</button>
        `;
        container.appendChild(div);
      }
    }

    // --- ×¦×•×¨ ×¨×©×™××” ---
    async function createList() {
      const name = document.getElementById("listName").value.trim();
      if (!name) return alert("×™×© ×œ×”×–×™×Ÿ ×©× ×œ×¨×©×™××”");
      const res = await fetch("/api/lists", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({name, words: []})
      });
      const data = await res.json();
      if (data.ok) loadLists();
    }

    // --- × ×™×”×•×œ ×¨×©×™××” ---
    async function manageList(name) {
      currentList = name;
      const res = await fetch("/api/lists");
      const data = await res.json();
      const words = data[name] || [];

      let html = `<h2>× ×™×”×•×œ ×¨×©×™××”: ${name} (×¢×“ 15 ××™×œ×™×)</h2>
      <div><input id='enWord' placeholder='English'> <input id='heWord' placeholder='×¢×‘×¨×™×ª'>
      <button onclick='addWord()'>×”×•×¡×£ ××™×œ×”</button></div><hr>`;

      words.forEach((w, i) => {
        const ratio = w.correct + w.wrong > 0 ? (w.wrong / (w.correct + w.wrong)).toFixed(2) : "0.00";
        html += `
          <div class='word-row'>
            <input id='en${i}' value='${w.en}' onchange='editWord(${i})'>
            <input id='he${i}' value='${w.he}' onchange='editWord(${i})'>
            <span>âœ… ${w.correct} âŒ ${w.wrong} ğŸ”¥ ×™×—×¡: ${ratio}</span>
            <button onclick='deleteWord(${i})'>××—×§</button>
          </div>`;
      });

      html += `<br><button onclick='loadLists()'>×—×–×¨×” ×œ×¨×©×™××•×ª</button>`;
      document.getElementById("main").innerHTML = html;
    }

    // --- ×”×•×¡×£ ××™×œ×” ---
    async function addWord() {
      const en = document.getElementById("enWord").value.trim();
      const he = document.getElementById("heWord").value.trim();
      if (!en || !he) return alert("×™×© ×œ××œ× ×’× ×× ×’×œ×™×ª ×•×’× ×¢×‘×¨×™×ª");

      const res = await fetch("/api/lists");
      const data = await res.json();
      const list = data[currentList] || [];

      if (list.length >= 15) return alert("×œ× × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×™×•×ª×¨ ×-15 ××™×œ×™× ×œ×¨×©×™××”");

      list.push({en, he, correct: 0, wrong: 0});
      await fetch("/api/lists", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({name: currentList, words: list})
      });
      manageList(currentList);
    }

    // --- ×¢×¨×™×›×ª ××™×œ×” ---
    async function editWord(index) {
      const res = await fetch("/api/lists");
      const data = await res.json();
      const list = data[currentList];
      list[index].en = document.getElementById(`en${index}`).value;
      list[index].he = document.getElementById(`he${index}`).value;
      await fetch("/api/lists", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({name: currentList, words: list})
      });
    }

    // --- ××—×™×§×ª ××™×œ×” ---
    async function deleteWord(index) {
      const res = await fetch("/api/lists");
      const data = await res.json();
      const list = data[currentList];
      list.splice(index, 1);
      await fetch("/api/lists", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({name: currentList, words: list})
      });
      manageList(currentList);
    }

    // --- ×ª×¨×’×•×œ ---
    async function startQuiz(name, mode) {
      const res = await fetch("/api/lists");
      const data = await res.json();
      const words = data[name];

      // ×¡×“×¨ ×œ×¤×™ ×™×—×¡ ×©×’×™××•×ª
      const sorted = words
        .map(w => ({...w, ratio: (w.wrong + 1) / (w.correct + 1)}))
        .sort((a, b) => b.ratio - a.ratio);

      let i = 0;
      showQuestion();

      function showQuestion() {
        if (i >= sorted.length) return loadLists();
        const w = sorted[i];
        const question = mode === "en2he" ? w.en : w.he;
        const answer = mode === "en2he" ? w.he : w.en;

        document.getElementById("main").innerHTML = `
          <h2>××™×œ×” ${i + 1} ××ª×•×š ${sorted.length}</h2>
          <p>${question}</p>
          <input id='ans' placeholder='×ª×¨×’×•×...'>
          <button onclick='check()'>×‘×“×•×§</button>
        `;

        window.check = async function() {
          const user = document.getElementById("ans").value.trim();
          if (user === answer) {
            alert("× ×›×•×Ÿ!");
            w.correct++;
          } else {
            alert("×©×’×•×™! ×”×ª×©×•×‘×” ×”× ×›×•× ×”: " + answer);
            w.wrong++;
          }
          data[name] = words;
          await fetch("/api/lists", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({name, words})
          });
          i++;
          showQuestion();
        };
      }
    }

    // --- ×™×™×‘×•× ×§×•×‘×¥ Excel ---
    async function importExcel() {
      const fileInput = document.getElementById("excelFile");
      const file = fileInput.files[0];
      if (!file) return alert("×‘×—×¨ ×§×•×‘×¥ Excel ×œ×™×™×‘×•×");

      const formData = new FormData();
      formData.append("file", file);

      try {
        const res = await fetch("/api/import_excel", { method: "POST", body: formData });
        const data = await res.json();
        alert(data.message); // ×™×•×¦×’ ×‘×¢×‘×¨×™×ª ×ª×§×™× ×”
        if (data.ok) loadLists();
      } catch (err) {
        alert("×©×’×™××” ×‘×™×™×‘×•× ×”×§×•×‘×¥: " + err);
      }
    }

    // --- ×™×™×¦×•× ×§×•×‘×¥ Excel ---
    async function exportExcel() {
      const res = await fetch("/api/export_excel");
      const data = await res.json();
      alert(data.message);
    }

    window.onload = loadLists;
  </script>
</head>
<body>
  <div class="container">
    <h1>ğŸ“˜ ××ª×¨ ×œ×™××•×“ ××™×œ×™× ×‘×× ×’×œ×™×ª</h1>
    <h3>×™×¦×™×¨×ª ×¨×©×™××” ×—×“×©×”</h3>
    <input id="listName" placeholder="×©× ×”×¨×©×™××”">
    <button onclick="createList()">×¦×•×¨ ×¨×©×™××”</button>

    <h3>×™×™×‘×•× ××§×•×‘×¥ Excel ğŸ§¾</h3>
    <input type="file" id="excelFile" accept=".xlsx">
    <button onclick="importExcel()">×™×™×‘× ×§×•×‘×¥</button>

    <h3>×™×™×¦×•× ×¨×©×™××•×ª ×œ×§×•×‘×¥ Excel ğŸ’¾</h3>
    <button onclick="exportExcel()">×”×•×¨×“ ×§×•×‘×¥ Excel</button>

    <hr>
    <div id="lists"></div>
    <div id="main"></div>
  </div>
</body>
</html>
