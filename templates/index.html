<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×œ×™××•×“ ××™×œ×™× ×‘×× ×’×œ×™×ª</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="container">
    <h1>××ª×¨ ×œ×™××•×“ ××™×œ×™× ×‘×× ×’×œ×™×ª ğŸ“˜</h1>

    <!-- ×™×¦×™×¨×ª ×¨×©×™××” ×—×“×©×” -->
    <section>
      <h2>â• ×™×¦×™×¨×ª ×¨×©×™××” ×—×“×©×”</h2>
      <input id="newListName" placeholder="×©× ×”×¨×©×™××”" />
      <button id="createBtn">×¦×•×¨ ×¨×©×™××”</button>
    </section>

    <!-- ×›×œ ×”×¨×©×™××•×ª -->
    <section>
      <h2>ğŸ“„ ×”×¨×©×™××•×ª ×©×œ×š</h2>
      <div id="lists"></div>
    </section>

    <hr/>

    <!-- × ×™×”×•×œ ×¨×©×™××” -->
    <section id="manage" style="display:none;">
      <h2>× ×™×”×•×œ ×¨×©×™××”: <span id="mListName"></span> (×¢×“ 15 ××™×œ×™×)</h2>

      <div class="row">
        <input id="en" placeholder="English" />
        <input id="he" placeholder="×¢×‘×¨×™×ª" />
        <button onclick="addWord()">×”×•×¡×£ ××™×œ×”</button>
      </div>

      <ul id="words"></ul>
      <button class="secondary" onclick="backToLists()">×—×–×¨×” ×œ×¨×©×™××•×ª</button>
    </section>

    <hr/>

    <!-- ×—×™×“×•×Ÿ -->
    <section id="quiz" style="display:none;">
      <h2>×—×™×“×•×Ÿ: <span id="qListName"></span></h2>
      <div id="qNumber"></div>
      <div id="qPrompt"></div>
      <input id="qAnswer" placeholder="×”×ª×©×•×‘×” ×©×œ×š" onkeydown="if(event.key==='Enter') checkAnswer()" />
      <button onclick="checkAnswer()">×‘×“×•×§</button>
      <div id="qFeedback"></div>
      <button class="secondary" onclick="showManage()">×¡×™×•× ×—×™×“×•×Ÿ</button>
    </section>
  </div>

<script>
  // ===== ×˜×¢×™× ×” ×¨××©×•× ×™×ª =====
  document.addEventListener("DOMContentLoaded", () => {
    loadLists();
    document.getElementById("createBtn").addEventListener("click", createList);
  });

  // ===== ×¨×©×™××•×ª =====
  async function loadLists() {
    try {
      const r = await fetch("/api/lists");
      if (!r.ok) throw new Error("×‘×¢×™×” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª");
      const js = await r.json();
      const cont = document.getElementById("lists");
      cont.innerHTML = "";
      js.lists.forEach(li => {
        const row = document.createElement("div");
        row.className = "list-row";
        row.innerHTML = `
          <div class="list-name">${li.name}</div>
          <div class="list-stats">××™×œ×™×: ${li.count} | âœ… ${li.ok} | âŒ ${li.bad}</div>
          <div class="list-actions">
            <button onclick="manage('${li.name}')">× ×”×œ</button>
            <button onclick="startQuickQuiz('${li.name}', 'en2he')">×ª×¨×’×•×œ ENâ†’HE</button>
            <button onclick="startQuickQuiz('${li.name}', 'he2en')">×ª×¨×’×•×œ HEâ†’EN</button>
          </div>
        `;
        cont.appendChild(row);
      });
    } catch (err) {
      alert("×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×©×™××•×ª:\n" + err.message);
    }
  }

  async function createList() {
    const name = document.getElementById("newListName").value.trim();
    if (!name) return alert("× × ×œ×”×–×™×Ÿ ×©× ×œ×¨×©×™××”");

    try {
      const r = await fetch("/api/lists", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name })
      });

      const js = await r.json();
      if (!js.ok) {
        alert(js.error || "×©×’×™××” ×‘×”×•×¡×¤×ª ×”×¨×©×™××”");
        return;
      }

      document.getElementById("newListName").value = "";
      alert("×”×¨×©×™××” × ×•×¡×¤×” ×‘×”×¦×œ×—×”!");
      loadLists();
    } catch (err) {
      alert("×©×’×™××” ×‘×¢×ª ×™×¦×™×¨×ª ×¨×©×™××”:\n" + err.message);
    }
  }

  // ===== × ×™×”×•×œ ××™×œ×™× =====
  let currentList = null;
  let currentWords = [];

  async function manage(name) {
    currentList = name;
    document.getElementById("mListName").innerText = name;
    document.getElementById("manage").style.display = "";
    document.getElementById("quiz").style.display = "none";
    await refreshWords();
  }

  async function refreshWords() {
    const r = await fetch(`/api/list/${encodeURIComponent(currentList)}`);
    const js = await r.json();
    currentWords = js.words || [];

    const ul = document.getElementById("words");
    ul.innerHTML = "";
    currentWords.forEach(w => {
      const ratio = w.ratio !== undefined ? w.ratio.toFixed(2) : (w.bad / (w.ok + 1)).toFixed(2);
      const li = document.createElement("li");
      li.innerHTML = `
        <span>${w.en} â€” ${w.he}</span>
        <span class="chip">âœ… ${w.ok || 0}</span>
        <span class="chip">âŒ ${w.bad || 0}</span>
        <span class="chip">ğŸ”¥ ×™×—×¡: ${ratio}</span>
        <button class="danger" onclick="deleteWord('${w.en}', '${w.he}')">××—×§</button>
      `;
      ul.appendChild(li);
    });
  }

  async function addWord() {
    const en = document.getElementById("en").value.trim();
    const he = document.getElementById("he").value.trim();
    if (!en || !he) return alert("× × ×œ××œ× ××ª ×©×ª×™ ×”×©×“×•×ª");

    const r = await fetch("/api/words", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ list: currentList, en, he })
    });
    const js = await r.json();
    if (!js.ok) return alert(js.error || "×©×’×™××”");
    document.getElementById("en").value = "";
    document.getElementById("he").value = "";
    refreshWords();
    loadLists();
  }

  async function deleteWord(en, he) {
    if (!confirm(`×œ××—×•×§ ××ª ×”××™×œ×” "${en}"?`)) return;
    const url = `/api/words?list=${encodeURIComponent(currentList)}&en=${encodeURIComponent(en)}&he=${encodeURIComponent(he)}`;
    const r = await fetch(url, { method: "DELETE" });
    const js = await r.json();
    if (!js.ok) return alert(js.error || "×©×’×™××” ×‘××—×™×§×”");
    refreshWords();
    loadLists();
  }

  // ===== ×—×–×¨×” =====
  function backToLists() {
    document.getElementById("manage").style.display = "none";
    document.getElementById("quiz").style.display = "none";
    loadLists();
  }

  // ===== ×—×™×“×•×Ÿ =====
  async function startQuickQuiz(listName, mode) {
    currentList = listName;
    quizMode = mode;
    const r = await fetch(`/api/list/${encodeURIComponent(listName)}`);
    const js = await r.json();
    if (!js.ok) return alert("×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¨×©×™××”");
    currentWords = js.words || [];
    if (currentWords.length === 0) return alert("××™×Ÿ ××™×œ×™× ×‘×¨×©×™××” ×”×–×•!");

    // ××™×™×Ÿ ×œ×¤×™ ×™×—×¡ ×™×•×¨×“ (×§×©×•×ª ×§×•×“×)
    quizOrder = [...currentWords.keys()].sort((a, b) => {
      const ratioA = currentWords[a].ratio ?? (currentWords[a].bad / (currentWords[a].ok + 1));
      const ratioB = currentWords[b].ratio ?? (currentWords[b].bad / (currentWords[b].ok + 1));
      return ratioB - ratioA;
    });

    quizIndex = 0;
    document.getElementById("qListName").innerText = `${listName} (${mode === 'en2he' ? 'ENâ†’HE' : 'HEâ†’EN'})`;
    document.getElementById("quiz").style.display = "";
    document.getElementById("manage").style.display = "none";
    showQuestion();
  }

  let quizMode = "en2he";
  let quizOrder = [];
  let quizIndex = 0;

  function showQuestion() {
    if (quizIndex >= quizOrder.length) {
      document.getElementById("qPrompt").innerText = "×¡×™×™××ª ××ª ×”×—×™×“×•×Ÿ! ğŸ‰";
      document.getElementById("qNumber").innerText = "";
      document.getElementById("qFeedback").innerText = "";
      return;
    }
    const w = currentWords[quizOrder[quizIndex]];
    document.getElementById("qNumber").innerText = `×©××œ×” ${quizIndex + 1} ××ª×•×š ${quizOrder.length}`;
    document.getElementById("qAnswer").value = "";
    document.getElementById("qAnswer").focus();

    if (quizMode === "en2he") {
      document.getElementById("qPrompt").innerText = `×ª×¨×’× ×œ×¢×‘×¨×™×ª: ${w.en}`;
    } else {
      document.getElementById("qPrompt").innerText = `Translate to English: ${w.he}`;
    }
    document.getElementById("qFeedback").innerText = "";
  }

  async function checkAnswer() {
    if (quizIndex >= quizOrder.length) return;
    const w = currentWords[quizOrder[quizIndex]];
    const ans = document.getElementById("qAnswer").value.trim();
    const correct = quizMode === "en2he" ? w.he : w.en;
    const isCorrect = ans.toLowerCase() === correct.toLowerCase();

    document.getElementById("qFeedback").innerText = isCorrect ? "âœ… × ×›×•×Ÿ!" : `âŒ ×œ× × ×›×•×Ÿ. ×”×ª×©×•×‘×”: ${correct}`;

    await fetch("/api/answer", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ list: currentList, en: w.en, he: w.he, correct: isCorrect })
    });

    quizIndex++;
    setTimeout(() => showQuestion(), 700);
  }

  function showManage() {
    document.getElementById("quiz").style.display = "none";
    document.getElementById("manage").style.display = "";
    refreshWords();
  }
</script>
</body>
</html>
