<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>ğŸ“˜ ××ª×¨ ×œ×™××•×“ ××™×œ×™× ×‘×× ×’×œ×™×ª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; direction: rtl; background: #f9f9f9; margin: 0; padding: 20px; }
    h1 { text-align: center; }
    button { padding: 8px 14px; border: none; border-radius: 8px; cursor: pointer; background: #1976d2; color: white; }
    button:hover { background: #125a9e; }
    .card { background: white; margin: 10px auto; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 500px; }
    .date { color: #555; font-size: 14px; }
    .stats { margin: 8px 0; }
    .ok { color: green; }
    .bad { color: red; }
  </style>
</head>

<body>
  <h1>ğŸ“˜ ××ª×¨ ×œ×™××•×“ ××™×œ×™× ×‘×× ×’×œ×™×ª</h1>

  <div class="card">
    <h3>â• ×™×¦×™×¨×ª ×¨×©×™××” ×—×“×©×”</h3>
    <input id="newListName" placeholder="×©× ×”×¨×©×™××”">
    <button onclick="createList()">×¦×•×¨ ×¨×©×™××”</button>
  </div>

  <div class="card">
    <h3>ğŸ“¥ ×™×™×‘×•× ××§×•×‘×¥ Excel</h3>
    <input type="file" id="fileInput">
    <button onclick="importExcel()">×™×™×‘× ×§×•×‘×¥</button>
  </div>

  <div class="card">
    <h3>ğŸ“¤ ×”×•×¨×“ ××ª ×›×œ ×”××™×œ×™× ×œ×§×•×‘×¥ Excel</h3>
    <button onclick="downloadAll()">×”×•×¨×“ ××ª ×›×œ ×”× ×ª×•× ×™×</button>
  </div>

  <h3 style="text-align:center;">ğŸ“‹ ×”×¨×©×™××•×ª ×©×œ×š (××¡×•×“×¨×•×ª ×œ×¤×™ ×ª××¨×™×š ×—×™×“×•×Ÿ)</h3>
  <div id="listsContainer"></div>

  <script>
    async function loadLists() {
      const res = await fetch("/api/lists");
      const lists = await res.json();
      const container = document.getElementById("listsContainer");
      container.innerHTML = "";

      for (const list of lists) {
        const lastQuiz = list.last_quiz_date ? new Date(list.last_quiz_date).toLocaleDateString('he-IL') : "â€”";
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h3>×¨×©×™××” ${list.id}</h3>
          <div class="stats">
            ××™×œ×™×: <span class="ok">âœ… ${list.correct}</span> /
            <span class="bad">âŒ ${list.wrong}</span>
          </div>
          <div class="date">ğŸ“… × ×‘×—× ×ª ×œ××—×¨×•× ×”: ${lastQuiz}</div>
          <button onclick="startQuiz('${list.name}')">ğŸ¯ ×”×ª×—×œ ×—×™×“×•×Ÿ</button>
          <button onclick="manageList('${list.name}')">× ×”×œ</button>
        `;
        container.appendChild(card);
      }
    }

    async function startQuiz(listName) {
      alert("ğŸ¯ ×”×—×™×“×•×Ÿ ×”×ª×—×™×œ ×œ×¨×©×™××”: " + listName);

      // === ×¢×“×›×•×Ÿ ×ª××¨×™×š ×—×™×“×•×Ÿ ××—×¨×•×Ÿ ×‘×©×¨×ª ===
      try {
        await fetch("/api/update_quiz_date", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ list_name: listName })
        });
        console.log("âœ… ×¢×•×“×›×Ÿ ×ª××¨×™×š ×—×™×“×•×Ÿ ××—×¨×•×Ÿ ×œÖ¾", listName);
      } catch (e) {
        console.error("âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×ª××¨×™×š:", e);
      }

      await loadLists(); // ×¨×™×¢× ×•×Ÿ ×›×“×™ ×œ×”×¦×™×’ ××ª ×”×ª××¨×™×š ×”×—×“×©
    }

    async function createList() {
      const name = document.getElementById("newListName").value.trim();
      if (!name) return alert("×× × ×”×›× ×¡ ×©× ×¨×©×™××”");
      await fetch("/api/create_list", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name })
      });
      await loadLists();
    }

    async function importExcel() {
      const fileInput = document.getElementById("fileInput");
      if (!fileInput.files.length) return alert("×‘×—×¨ ×§×•×‘×¥ ×§×•×“×");
      const formData = new FormData();
      formData.append("file", fileInput.files[0]);
      const res = await fetch("/api/import_excel", { method: "POST", body: formData });
      const data = await res.json();
      alert(data.message || "×”×¡×ª×™×™×!");
      await loadLists();
    }

    async function downloadAll() {
      window.location.href = "/api/export_excel";
    }

    async function manageList(name) {
      alert("× ×™×”×•×œ ×”×¨×©×™××”: " + name);
    }

    loadLists();
  </script>
</body>
</html>