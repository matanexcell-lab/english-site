<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“˜ ××ª×¨ ×œ×™××•×“ ××™×œ×™× ×‘×× ×’×œ×™×ª</title>
  <link rel="stylesheet" href="/static/style.css">
  <script>
  let currentList = null;
  let allLists = {};

  async function loadLists() {
    const res = await fetch('/api/lists');
    allLists = await res.json();
    renderLists();
  }

  function renderLists() {
    const container = document.getElementById("lists");
    container.innerHTML = "";
    for (const [name, words] of Object.entries(allLists)) {
      const correct = words.reduce((a,w)=>a+(w.correct||0),0);
      const wrong = words.reduce((a,w)=>a+(w.wrong||0),0);
      const div = document.createElement("div");
      div.innerHTML = `
        <h3>${name}</h3>
        <p>××™×œ×™×: ${words.length} âœ… ${correct} âŒ ${wrong}</p>
        <button onclick="manageList('${name}')">× ×”×œ</button>
        <button onclick="startQuiz('${name}','EN2HE')">×ª×¨×’×•×œ ENâ†’HE</button>
        <button onclick="startQuiz('${name}','HE2EN')">×ª×¨×’×•×œ HEâ†’EN</button>
      `;
      container.appendChild(div);
    }
  }

  function manageList(name) {
    currentList = name;
    const list = allLists[name];
    const area = document.getElementById("manageArea");
    area.innerHTML = `<h3>× ×™×”×•×œ ×¨×©×™××”: ${name}</h3>`;

    list.forEach((w, i) => {
      const ratio = w.wrong ? (w.wrong / (w.correct || 1)).toFixed(2) : 0;
      const div = document.createElement("div");
      div.innerHTML = `
        <div id="row-${i}">
          ğŸ”¥ ×™×—×¡: ${ratio}
          âŒ ${w.wrong || 0} âœ… ${w.correct || 0}
          <span>â€” ${w.en} â€” ${w.he}</span>
          <button onclick="editWord(${i})">âœï¸ ×¢×¨×•×š</button>
          <button onclick="deleteWord(${i})" style="background:red;color:white;">××—×§</button>
        </div>
      `;
      area.appendChild(div);
    });

    area.innerHTML += `
      <br><input id="newEn" placeholder="English">
      <input id="newHe" placeholder="×¢×‘×¨×™×ª">
      <button onclick="addWord()">×”×•×¡×£ ××™×œ×”</button>
      <br><button onclick="backToLists()">×—×–×¨×” ×œ×¨×©×™××•×ª</button>
    `;

    document.getElementById("main").style.display = "none";
    area.style.display = "block";
  }

  function editWord(index) {
    const list = allLists[currentList];
    const word = list[index];
    const div = document.getElementById(`row-${index}`);
    div.innerHTML = `
      <input id="editEn-${index}" value="${word.en}">
      <input id="editHe-${index}" value="${word.he}">
      âœ… <input id="editCorrect-${index}" type="number" value="${word.correct || 0}" min="0" style="width:40px;">
      âŒ <input id="editWrong-${index}" type="number" value="${word.wrong || 0}" min="0" style="width:40px;">
      <button onclick="saveEdit(${index})">ğŸ’¾ ×©××•×¨</button>
      <button onclick="manageList('${currentList}')">×‘×™×˜×•×œ</button>
    `;
  }

  function saveEdit(index) {
    const en = document.getElementById(`editEn-${index}`).value.trim();
    const he = document.getElementById(`editHe-${index}`).value.trim();
    const correct = parseInt(document.getElementById(`editCorrect-${index}`).value) || 0;
    const wrong = parseInt(document.getElementById(`editWrong-${index}`).value) || 0;
    allLists[currentList][index] = { en, he, correct, wrong };
    saveData();
    manageList(currentList);
  }

  function addWord() {
    const en = document.getElementById("newEn").value.trim();
    const he = document.getElementById("newHe").value.trim();
    if (!en || !he) return alert("× × ×œ××œ× ××ª ×©×ª×™ ×”×©×“×•×ª");
    allLists[currentList].push({ en, he, correct: 0, wrong: 0 });
    saveData();
    manageList(currentList);
  }

  function deleteWord(index) {
    if (!confirm("×œ××—×•×§ ××™×œ×” ×–×•?")) return;
    allLists[currentList].splice(index, 1);
    saveData();
    manageList(currentList);
  }

  async function saveData() {
    await fetch('/api/lists', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ name: currentList, words: allLists[currentList] })
    });
    loadLists();
  }

  function backToLists() {
    document.getElementById("manageArea").style.display = "none";
    document.getElementById("main").style.display = "block";
  }

  async function importExcel() {
    const fileInput = document.getElementById("excelFile");
    const file = fileInput.files[0];
    if (!file) return alert("×‘×—×¨ ×§×•×‘×¥ ×§×•×“×");
    const formData = new FormData();
    formData.append("file", file);
    const res = await fetch("/api/import_excel", { method: "POST", body: formData });
    const msg = await res.text();
    alert(msg);
    loadLists();
  }

  window.onload = loadLists;
  </script>
</head>
<body>
  <div id="main" class="container">
    <h1>ğŸ“˜ ××ª×¨ ×œ×™××•×“ ××™×œ×™× ×‘×× ×’×œ×™×ª</h1>

    <div>
      <h3>â• ×™×¦×™×¨×ª ×¨×©×™××” ×—×“×©×”</h3>
      <input id="listName" placeholder="×©× ×”×¨×©×™××”">
      <button onclick="
        const name = listName.value.trim();
        if(!name) return alert('×”×›× ×¡ ×©× ×œ×¨×©×™××”');
        allLists[name] = [];
        saveData();
      ">×¦×•×¨ ×¨×©×™××”</button>

      <h3>ğŸ“¤ ×™×™×‘×•× ×§×•×‘×¥ Excel</h3>
      <input type="file" id="excelFile" accept=".xlsx">
      <button onclick="importExcel()">×™×™×‘× ×§×•×‘×¥</button>
    </div>

    <h3>ğŸ“‹ ×”×¨×©×™××•×ª ×©×œ×š</h3>
    <div id="lists"></div>
  </div>

  <div id="manageArea" class="container" style="display:none"></div>
</body>
</html>
